(()=>{"use strict";window.utils={getRandomInt:e=>Math.floor(Math.random()*Math.floor(e)),getMaxElement:e=>{let t=e[0];for(let i=0;i<e.length;i++)e[i]>t&&(t=e[i]);return t},isEscEvent:(e,t)=>{"Escape"===e.key&&(e.preventDefault(),t())},isEnterEvent:(e,t)=>{"Enter"===e.key&&(e.preventDefault(),t())},isElementFocused:(e,t)=>()=>{e!==document.activeElement&&t()}},window.debounce=e=>{let t=null;return()=>{t&&window.clearTimeout(t),t=window.setTimeout((()=>{e()}),500)}},window.params={fireballSize:22,wizardSpeed:3,wizardWidth:70,getFireballSpeed:e=>e?2:5,getWizardHeight:e=>1.337*e,getWizardX:e=>(e-window.params.wizardWidth)/2,getWizardY:e=>e/3},window.alert={renderAlert:e=>{const t=document.querySelector("header"),i=document.createElement("div"),s=document.createElement("p");i.style="position: absolute; z-index: 5; top: 0; left: 0; right: 0; background-color: red; display: flex; justify-content: center; align-items: center",s.style="color: white",s.textContent=e,i.appendChild(s),t.appendChild(i)}},(()=>{const e=(e,t,i,s)=>{e.responseType="json",e.addEventListener("load",(()=>{let s;switch(e.status){case 200:t(e.response);break;case 400:s="Неверный запрос";break;case 401:s="Пользователь не авторизирован";break;case 404:s="Ничего не найдено";break;default:s=`Статус ответа: ${e.status} ${e.statusText}`}s&&i(s)})),e.addEventListener("error",(()=>{i("Произошла ошибка соединения")})),e.addEventListener("timeot",(()=>{i(`Запрос не успел выполниться за ${e.timeout}мс`)})),e.timeout=s};window.backend={load:(t,i)=>{const s=new XMLHttpRequest;e(s,t,i,1e4),s.open("GET","https://21.javascript.pages.academy/code-and-magick/data"),s.send()},save:(t,i,s)=>{const n=new XMLHttpRequest;e(n,i,s,1e4),n.open("POST","https://21.javascript.pages.academy/code-and-magick"),n.send(t)}}})(),(()=>{const e="#000",t=(e,t,i,s)=>{e.fillStyle=s,e.fillRect(t,i,420,270)},i=(t,i,s,n,a)=>{let r=150*s/n,o="Вы"===i?"rgba(255, 0, 0, 1)":`hsla(240, ${window.utils.getRandomInt(100)}%, 50%, 1)`;t.fillStyle=o,t.fillRect(140+90*a,240,40,-r),t.fillStyle=e,t.fillText(i,140+90*a,250),t.fillText(Math.round(s),140+90*a,220-r)};window.stat={renderStatistics:(s,n,a)=>{t(s,110,20,"rgba(0, 0, 0, 0.7)"),t(s,100,10,"#FFF"),s.fillStyle=e,s.font="16px PT Mono",s.textBaseline="hanging",s.fillText("Ура вы победили!",120,30),s.fillText("Список результатов:",120,46);let r=window.utils.getMaxElement(a);for(let e=0;e<n.length;e++)i(s,n[e],a[e],r,e)}}})(),(()=>{const e=document.querySelector(".setup"),t=document.querySelector("#similar-wizard-template").content.querySelector(".setup-similar-item"),i=e.querySelector(".setup-similar-list"),s=e.querySelector(".setup-similar");let n=[];const a=e=>{const i=t.cloneNode(!0);return i.querySelector(".setup-similar-label").textContent=e.name,i.querySelector(".wizard-coat").style.fill=e.colorCoat,i.querySelector(".wizard-eyes").style.fill=e.colorEyes,i},r=e=>{let t=0;return e.colorCoat===window.setup.coatColor&&(t+=2),e.colorEyes===window.setup.eyesColor&&(t+=1),t},o=()=>{(e=>{for(;i.lastChild;)i.removeChild(i.lastChild);const t=document.createDocumentFragment();for(let i=0;i<4;i++)t.appendChild(a(e[i]));i.appendChild(t)})(n.sort(((e,t)=>{let i=r(t)-r(e);return 0===i&&(i=((e,t)=>e>t?1:e<t?-1:0)(e.name,t.name)),i})))};window.backend.load((e=>{n=e,o()}),window.alert.renderAlert),s.classList.remove("hidden"),window.similarWizards={updateWizards:o}})(),(()=>{const e=["rgb(101, 137, 164)","rgb(241, 43, 107)","rgb(146, 100, 161)","rgb(56, 159, 117)","rgb(215, 210, 55)","rgb(0, 0, 0)"],t=["black","red","blue","yellow","green"],i=["#ee4830","#30a8ee","#5ce6c0","#e848d5","#e6e848"],s=document.querySelector(".setup"),n=document.querySelector(".setup-open"),a=s.querySelector(".setup-close"),r=s.querySelector(".setup-user-name"),o=s.querySelector(".setup-wizard-form"),d=o.querySelector(".setup-wizard .wizard-coat"),l=o.querySelector('input[name="coat-color"]'),c=o.querySelector(".setup-wizard .wizard-eyes"),u=o.querySelector('input[name="eyes-color"]'),h=o.querySelector(".setup-fireball-wrap"),w=o.querySelector('input[name="fireball-color"]');let m=e[0],p=t[0];const y=e=>{window.utils.isEscEvent(e,window.utils.isElementFocused(r,g))},f=()=>{s.classList.remove("hidden"),document.addEventListener("keydown",y)},g=()=>{s.classList.add("hidden"),s.style.top=null,s.style.left=null,document.removeEventListener("keydown",y)},v=window.debounce(window.similarWizards.updateWizards),S=window.debounce(window.similarWizards.updateWizards);n.addEventListener("click",f),n.addEventListener("keydown",(e=>{window.utils.isEnterEvent(e,f)})),a.addEventListener("click",g),a.addEventListener("keydown",(e=>{window.utils.isEnterEvent(e,g)})),d.addEventListener("click",(()=>{m=e[window.utils.getRandomInt(e.length)],window.setup.coatColor=m,d.style.fill=m,l.value=m,v()})),c.addEventListener("click",(()=>{p=t[window.utils.getRandomInt(t.length)],window.setup.eyesColor=p,c.style.fill=p,u.value=p,S()})),h.addEventListener("click",(()=>{const e=i[window.utils.getRandomInt(i.length)];h.style.backgroundColor=e,w.value=e})),o.addEventListener("submit",(e=>{window.backend.save(new FormData(o),g,window.alert.renderAlert),e.preventDefault()})),window.setup={coatColor:m,eyesColor:p}})(),(()=>{const e=document.querySelector(".setup"),t=document.querySelector(".upload");t.addEventListener("mousedown",(i=>{i.preventDefault();let s={x:i.clientX,y:i.clientY},n=!1;const a=t=>{t.preventDefault(),n=!0;const i=s.x-t.clientX,a=s.y-t.clientY;s={x:t.clientX,y:t.clientY},e.style.top=e.offsetTop-a+"px",e.style.left=e.offsetLeft-i+"px"},r=e=>{if(e.preventDefault(),document.removeEventListener("mousemove",a),document.removeEventListener("mouseup",r),n){const e=i=>{i.preventDefault(),t.removeEventListener("click",e)};t.addEventListener("click",e)}};document.addEventListener("mousemove",a),document.addEventListener("mouseup",r)}))})(),window.GameConstants={Fireball:{size:window.params.fireballSize||24,speed:window.params.getFireballSpeed||function(e){return e?2:5}},Wizard:{speed:window.params.wizardSpeed||2,width:window.params.wizardWidth||61,getHeight:window.params.getWizardHeight||function(e){return 1.377*e},getX:window.params.getWizardX||function(e){return e/3},getY:window.params.getWizardY||function(e){return e-100}}},window.Game=function(){const e=300,t=700,i=["Кекс","Катя","Игорь"],s={},n="-reversed";s[0]={width:61,height:84,url:"img/wizard.gif"},s[0+n]={width:61,height:84,url:"img/wizard-reversed.gif"},s[1]={width:24,height:24,url:"img/fireball.gif"};let a={0:function(i,s,n){s.keysPressed.UP&&i.y>0&&(i.direction=-9&i.direction,i.direction=4|i.direction,i.y-=i.speed*n*2),s.keysPressed.UP||i.y<e-i.height&&(i.direction=-5&i.direction,i.direction=8|i.direction,i.y+=i.speed*n/3),s.keysPressed.LEFT&&(i.direction=-3&i.direction,i.direction=1|i.direction,i.x-=i.speed*n),s.keysPressed.RIGHT&&(i.direction=-2&i.direction,i.direction=2|i.direction,i.x+=i.speed*n),i.y<0&&(i.y=0),i.y>e-i.height&&(i.y=e-i.height),i.x<0&&(i.x=0),i.x>t-i.width&&(i.x=t-i.width)},1:function(e,i,s){1&e.direction&&(e.x-=e.speed*s),2&e.direction&&(e.x+=e.speed*s),(e.x<0||e.x>t)&&(e.state=1)}};const r={CONTINUE:0,WIN:1,FAIL:2,PAUSE:3,INTRO:4};let o={0:function(e){return e.garbage.filter((function(e){return 1===e.type})).filter((function(e){return e.x<10&&e.y>240}))[0]?r.WIN:r.CONTINUE}},d={0:function(i){return i.objects.push({direction:2,height:window.GameConstants.Wizard.getHeight(window.GameConstants.Wizard.width),speed:window.GameConstants.Wizard.speed,sprite:s[0],state:0,type:0,width:window.GameConstants.Wizard.width,x:window.GameConstants.Wizard.getX(t),y:window.GameConstants.Wizard.getY(e)}),i}},l=function(e){this.container=e,this.canvas=document.createElement("canvas"),this.canvas.width=e.clientWidth,this.canvas.height=e.clientHeight,this.container.appendChild(this.canvas),this.ctx=this.canvas.getContext("2d"),this._onKeyDown=this._onKeyDown.bind(this),this._onKeyUp=this._onKeyUp.bind(this),this._pauseListener=this._pauseListener.bind(this),this.setDeactivated(!1)};l.prototype={level:0,setDeactivated(e){this._deactivated!==e&&(this._deactivated=e,e?this._removeGameListeners():this._initializeGameListeners())},getInitialState:()=>({currentStatus:r.CONTINUE,garbage:[],lastUpdated:null,keysPressed:{ESC:!1,LEFT:!1,RIGHT:!1,SPACE:!1,UP:!1},levelStartTime:null,objects:[],startTime:null}),initializeLevelAndStart(e){(e=void 0===e||e)||!this.state?(this._imagesArePreloaded=void 0,this.state=this.getInitialState(),this.state=d[this.level](this.state)):this.state.currentStatus=r.CONTINUE,this.state.levelStartTime=Date.now(),this.state.startTime||(this.state.startTime=this.state.levelStartTime),this._preloadImagesForLevel(function(){this.render(),this._initializeGameListeners(),this.update()}.bind(this))},pauseLevel(e){e&&(this.state.currentStatus=e),this.state.keysPressed.ESC=!1,this.state.lastUpdated=null,this._removeGameListeners(),window.addEventListener("keydown",this._pauseListener),this._drawPauseScreen()},_pauseListener(e){if(32===e.keyCode&&!this._deactivated){e.preventDefault();let t=this.state.currentStatus===r.WIN||this.state.currentStatus===r.FAIL;this.initializeLevelAndStart(t),window.removeEventListener("keydown",this._pauseListener)}},_drawPauseScreen(){let e;switch(this.state.currentStatus){case r.WIN:if(window.stat.renderStatistics){let e=this._generateStatistics(new Date-this.state.startTime),t=this._shuffleArray(Object.keys(e));return void window.stat.renderStatistics(this.ctx,t,t.map((function(t){return e[t]})))}e="Вы победили Газебо!\nУра!";break;case r.FAIL:e="Вы проиграли!";break;case r.PAUSE:e="Игра на паузе!\nНажмите Пробел, чтобы продолжить";break;case r.INTRO:e="Добро пожаловать!\nНажмите Пробел для начала игры"}this._drawMessage(e)},_generateStatistics(e){let t={Вы:e};for(let s=0;s<i.length;s++){let n=e+(3e3*Math.random()-1500);n<1e3&&(n=1e3),t[i[s]]=n}return t},_shuffleArray(e){for(let t=e.length-1;t>0;t--){let i=Math.floor(Math.random()*(t+1)),s=e[t];e[t]=e[i],e[i]=s}return e},_drawMessage(e){let t=this.ctx,i=function(e,i,s,n){t.beginPath(),t.moveTo(e,i),t.lineTo(e+10,i+n/2),t.lineTo(e,i+n),t.lineTo(e+s/2,i+n-10),t.lineTo(e+s,i+n),t.lineTo(e+s-10,i+n/2),t.lineTo(e+s,i),t.lineTo(e+s/2,i+10),t.lineTo(e,i),t.stroke(),t.closePath(),t.fill()};t.fillStyle="rgba(0, 0, 0, 0.7)",i(190,40,320,100),t.fillStyle="rgba(256, 256, 256, 1.0)",i(180,30,320,100),t.fillStyle="#000",t.font="16px PT Mono",e.split("\n").forEach((function(e,i){t.fillText(e,200,80+20*i)}))},_preloadImagesForLevel(e){if(void 0===this._imagesArePreloaded&&(this._imagesArePreloaded=[]),this._imagesArePreloaded[this.level])return void e();let t=Object.keys(s),i=t.length,n=this,a=function(t){let s=new Image(t.width,t.height);s.onload=function(){t.image=s,0==--i&&(n._imagesArePreloaded[n.level]=!0,e())},s.src=t.url};for(let e=0;e<t.length;e++)a(s[t[e]])},updateObjects(e){let t=this.state.objects.filter((function(e){return 0===e.type}))[0];this.state.keysPressed.SHIFT&&(this.state.objects.push({direction:t.direction,height:window.GameConstants.Fireball.size,speed:window.GameConstants.Fireball.speed(!!(1&t.direction)),sprite:s[1],type:1,width:window.GameConstants.Fireball.size,x:2&t.direction?t.x+t.width:t.x-window.GameConstants.Fireball.size,y:t.y+t.height/2}),this.state.keysPressed.SHIFT=!1),this.state.garbage=[];let i=this.state.objects.filter((function(t){return a[t.type](t,this.state,e),1!==t.state||(this.state.garbage.push(t),!1)}),this);this.state.objects=i},checkStatus(){if(this.state.currentStatus!==r.CONTINUE)return;this.commonRules||(this.commonRules=[function(e){return 1===e.objects.filter((function(e){return 0===e.type}))[0].state?r.FAIL:r.CONTINUE},function(e){return e.keysPressed.ESC?r.PAUSE:r.CONTINUE},function(e){return Date.now()-e.startTime>18e4?r.FAIL:r.CONTINUE}]);let e,t=this.commonRules.concat(o[this.level]),i=r.CONTINUE;for(;i===r.CONTINUE&&t.length;)e=t.shift(),i=e(this.state);this.state.currentStatus=i},setGameStatus(e){this.state.currentStatus!==e&&(this.state.currentStatus=e)},render(){this.ctx.clearRect(0,0,t,e),this.state.objects.forEach((function(e){if(e.sprite){let t=1&e.direction,i=s[e.type+(t?n:"")]||s[e.type];this.ctx.drawImage(i.image,e.x,e.y,e.width,e.height)}}),this)},update(){this.state.lastUpdated||(this.state.lastUpdated=Date.now());let e=(Date.now()-this.state.lastUpdated)/10;switch(this.updateObjects(e),this.checkStatus(),this.state.currentStatus){case r.CONTINUE:this.state.lastUpdated=Date.now(),this.render(),requestAnimationFrame(function(){this.update()}.bind(this));break;case r.WIN:case r.FAIL:case r.PAUSE:case r.INTRO:this.pauseLevel()}},_onKeyDown(e){switch(e.keyCode){case 37:this.state.keysPressed.LEFT=!0;break;case 39:this.state.keysPressed.RIGHT=!0;break;case 38:this.state.keysPressed.UP=!0;break;case 27:this.state.keysPressed.ESC=!0}e.shiftKey&&(this.state.keysPressed.SHIFT=!0)},_onKeyUp(e){switch(e.keyCode){case 37:this.state.keysPressed.LEFT=!1;break;case 39:this.state.keysPressed.RIGHT=!1;break;case 38:this.state.keysPressed.UP=!1;break;case 27:this.state.keysPressed.ESC=!1}e.shiftKey&&(this.state.keysPressed.SHIFT=!1)},_initializeGameListeners(){window.addEventListener("keydown",this._onKeyDown),window.addEventListener("keyup",this._onKeyUp)},_removeGameListeners(){window.removeEventListener("keydown",this._onKeyDown),window.removeEventListener("keyup",this._onKeyUp)}},l.Verdict=r;let c=new l(document.querySelector(".demo"));return window.restartGame=function(e,t){s[0].url=e,s[0+n].url=t,c.initializeLevelAndStart(),c.setGameStatus(r.INTRO)},window.restartGame("img/wizard.gif","img/wizard-reversed.gif"),c}()})();